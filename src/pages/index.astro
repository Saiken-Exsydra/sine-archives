---
import MainLayout from "../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import { SECTIONS } from "../sections";
import { CONTENT_KEYS, type ContentKey } from "../content-keys";

const labelByKey = Object.fromEntries(SECTIONS.map((s) => [s.key, s.label])) as Record<string, string>;
const sections = CONTENT_KEYS.map((key) => ({ key, label: labelByKey[key] ?? key }));

async function getPublic(key: ContentKey) {
  const all = await getCollection(key);
  return all.filter((e) => e.data.status === "public");
}

const bySection = await Promise.all(
  sections.map(async (s) => {
    const entries = await getPublic(s.key);
    return { ...s, entries, count: entries.length };
  })
);

const totalPublic = bySection.reduce((sum, s) => sum + s.count, 0);

const allPublic = bySection.flatMap((s) =>
  s.entries.map((e) => ({ section: s.key, sectionLabel: s.label, entry: e }))
);

const lastUpdated =
  allPublic
    .slice()
    .sort((a, b) => (a.entry.data.updated < b.entry.data.updated ? 1 : -1))[0] ?? null;

const recent = allPublic
  .slice()
  .sort((a, b) => (a.entry.data.updated < b.entry.data.updated ? 1 : -1))
  .slice(0, 5);

const lastHref = lastUpdated
  ? `/${lastUpdated.section}/${lastUpdated.entry.slug}/`
  : "/search/";
---

<MainLayout active="home" pageTitle="SINE ARCHIVES">
  <section class="cards" aria-label="Dashboard stats">
  <article class="card card--wide">
      <div class="card__label">Latest Authorized Revision</div>

      {lastUpdated ? (
        <div class="last">
          <div class="last__title">{lastUpdated.entry.data.title}</div>
          <div class="last__meta">
            {lastUpdated.sectionLabel} · Updated: {String(lastUpdated.entry.data.updated).slice(0, 10)}
          </div>
          <a class="btn" href={lastHref}>Access Record</a>
        </div>
      ) : (
        <div class="last">
          <div class="last__title">No public entries yet</div>
          <div class="last__meta">—</div>
          <a class="btn" href="/search/">Open Search</a>
        </div>
      )}
    </article>
    <article class="card card--wide card--recent">
  <div class="card__label">Recent Record Activity</div>

  <div class="recent">
    {recent.map((r) => (
      <a class="recent__row" href={`/${r.section}/${r.entry.slug}/`}>
        <div class="recent__main">
          <div class="recent__title">{r.entry.data.title}</div>
          <div class="recent__meta">
            {r.sectionLabel} • {String(r.entry.data.updated).slice(0, 10)}
          </div>
        </div>
        <div class="recent__arrow" aria-hidden="true">→</div>
      </a>
    ))}
  </div>
</article>

    <article class="card card--primary">
      <div class="card__label">Total Public Entries</div>
      <div class="card__value">{totalPublic}</div>
    </article>

    {bySection.map((s) => (
      <article class="card">
        <div class="card__label">{s.label}</div>
        <div class="card__value">{s.count}</div>
      </article>
    ))}

    
  </section>

  <style>
    .cards{
      margin-top: 0;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 12px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }

    .card{
  padding: 18px 14px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.12);
  background: linear-gradient(180deg, rgba(9,12,20,0.82), rgba(7,8,13,0.82));
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 14px 30px rgba(0,0,0,0.24);
  min-height: 120px;

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;

  transition: transform 0.2s ease, border-color 0.2s ease;
}

.card:hover{
  transform: translateY(-2px);
  border-color: rgba(181, 58, 51, 0.52);
}

.card__label{
  font-size: 10px;
  letter-spacing: 0.24em;
  text-transform: uppercase;
  font-weight: 700;
  opacity: 0.76;
}


.card__value{
  margin-top: 12px;
  font-size: 50px;
  font-weight: 900;
  letter-spacing: 0.02em;
  line-height: 1;
}

.card--primary{
  background: linear-gradient(145deg, rgba(112,17,20,0.6), rgba(12,14,23,0.95));
  border-color: rgba(185,62,56,0.74);
}

.card--primary .card__value{
  font-size: 52px;
}


    .card--wide{
  grid-column: span 6;
  max-width: 100%;
  min-height: 130px;
  padding: 22px 18px;

  background: radial-gradient(1100px 220px at 45% 0%, rgba(180,82,50,0.2), transparent 66%),
    linear-gradient(180deg, rgba(12,15,24,0.9), rgba(8,9,13,0.92));

  border-color: rgba(255,255,255,0.13);
  align-items: stretch;
  text-align: left;
  position: relative;
  overflow: hidden;
}

.card--wide::after{
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent 45%);
}


.last{
  margin-top: 14px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.last__title{
  font-size: 48px;
  line-height: 1.08;
  font-weight: 700;
  letter-spacing: 0.03em;
  text-transform: uppercase;
  font-family: "Playfair Display", Georgia, serif;
}


.last__meta{
  font-size: 13px;
  font-weight: 550;
  opacity: 0.68;
  letter-spacing: 0.02em;
}

.last .btn{
  margin-top: 4px;
}

.card--recent{
  min-height: unset;
}



.btn{
  display: inline-flex;
  width: fit-content;
  text-decoration: none;
  color: var(--text);
  background: linear-gradient(180deg,#941d1d,#6f1114);
  border: 1px solid rgba(185,58,54,0.8);
  padding: 9px 20px;
  border-radius: 4px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  transition: transform 0.15s ease, background 0.15s ease, border-color 0.15s ease;
}

.btn:hover{
  background: rgba(122,13,20,0.75);
  border-color: rgba(122,13,20,0.95);
  transform: translateY(-2px);
}

.btn:focus-visible{
  outline: 2px solid rgba(176,141,60,0.55);
  outline-offset: 3px;
}

.recent{
  margin-top: 14px;
  display: grid;
  gap: 10px;
}

.recent__row{
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 12px;
  border-radius: 3px;
  text-decoration: none;
  color: inherit;
  border: 1px solid rgba(255,255,255,0.1);
  background: rgba(6,8,14,0.42);
  transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
}

.recent__row:hover{
  transform: translateY(-2px);
  border-color: rgba(176,141,60,0.25);
  background: rgba(8,8,12,0.55);
}

.recent__title{
  font-weight: 800;
  letter-spacing: -0.01em;
  line-height: 1.15;
}

.recent__meta{
  margin-top: 4px;
  font-size: 12px;
  opacity: 0.65;
  letter-spacing: 0.02em;
}

.recent__arrow{
  opacity: 0.6;
  font-weight: 800;
}

    @media (max-width: 980px){
      .cards{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .card--wide{ grid-column: span 2; }
    }
  </style>
</MainLayout>
