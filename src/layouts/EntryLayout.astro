---
import MainLayout from "./MainLayout.astro";
import { getCollection } from "astro:content";
import { CONTENT_KEYS } from "../content-keys";

const { entry, active } = Astro.props;
const { Content, headings } = await entry.render();


const sectionLabel =
  (active || "").charAt(0).toUpperCase() + (active || "").slice(1);
const sectionHref = `/${active}/`;
// ---- Related Entries (public-only) ----
function normalizeTags(tags: unknown): string[] {
  if (!Array.isArray(tags)) return [];
  return tags.map((t) => String(t).trim().toLowerCase()).filter(Boolean);
}

function sharedCount(a: string[], b: string[]): number {
  const setB = new Set(b);
  let n = 0;
  for (const t of a) if (setB.has(t)) n++;
  return n;
}

const currentSlug = entry.slug;
const currentTags = normalizeTags(entry.data?.tags);

const allPublic = (
  await Promise.all(
    CONTENT_KEYS.map((c) => getCollection(c, (e) => e.data.status === "public"))
  )
).flat();

const related = allPublic
  .filter((e) => e.slug !== currentSlug)
  .map((e) => {
    const tags = normalizeTags(e.data?.tags);
    const score = currentTags.length ? sharedCount(currentTags, tags) : 0;
    return { e, score };
  })
  .filter((x) => x.score > 0)
  .sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    const au = new Date(a.e.data?.updated ?? 0).getTime();
    const bu = new Date(b.e.data?.updated ?? 0).getTime();
    return bu - au;
  })
  .slice(0, 6);

---

<MainLayout active={active} pageTitle={`${entry.data.title} — ${sectionLabel} — SiNE Archives`}>
  <section class="wrap">
    <nav class="crumbs" aria-label="Breadcrumb">
      <a class="crumbs__link" href={sectionHref}>{sectionLabel}</a>
      <span class="crumbs__sep" aria-hidden="true">›</span>
      <span class="crumbs__current">{entry.data.title}</span>
    </nav>

    <header class="head">
      <div class="head__top">
        <h1 class="head__title">{entry.data.title}</h1>
        <div class="head__updated">Updated: {entry.data.updated}</div>
      </div>

      <p class="head__summary">{entry.data.summary}</p>

      {(entry.data.tags ?? []).length ? (
        <div class="tags" aria-label="Tags">
          {(entry.data.tags ?? []).map((t: string) => (
            <span class="tag">{String(t).toUpperCase()}</span>
          ))}
        </div>
      ) : null}

      {entry.data.image ? (
        <div class="media">
          <img class="media__img" src={entry.data.image} alt={`${entry.data.title} image`} loading="lazy" />
        </div>
      ) : null}
    </header>

{(headings?.length ?? 0) >= 3 ? (
  <aside class="toc" aria-label="Table of contents">
    <details class="toc__details">
      <summary class="toc__summary">On this page</summary>

      <nav class="toc__nav">
        <ul class="toc__list">
          {(headings as { depth: number; slug: string; text: string }[])
            .filter((h) => h.depth === 2 || h.depth === 3)
            .map((h) => (
              <li class={`toc__item toc__item--d${h.depth}`}>
                <a class="toc__link" href={`#${h.slug}`}>{h.text}</a>
              </li>
            ))}
        </ul>
      </nav>
    </details>
  </aside>
) : null}

    <article class="body" data-entry-body>
  <Content />
</article>

    {related.length ? (
  <section class="related" aria-label="Related entries">
    <h2 class="related__title">Related entries</h2>

    <div class="related__grid">
      {related.map(({ e, score }) => (
        <a class="related__item" href={`/${e.collection}/${e.slug}/`}>
          <div class="related__name">{e.data.title}</div>
          {e.data.summary ? (
            <div class="related__summary">{e.data.summary}</div>
          ) : null}
          <div class="related__meta">
            {score} shared tag{score === 1 ? "" : "s"}
          </div>
        </a>
      ))}
    </div>
  </section>
) : null}

  </section>

  <style>
    .wrap{
      margin-top: 18px;
      display: grid;
      gap: 14px;
    }

    .crumbs{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(176,141,60,0.16);
      background: rgba(15,15,22,0.35);
      width: fit-content;
    }

    .crumbs__link{
      color: var(--text);
      text-decoration: none;
      font-weight: 750;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 12px;
    }

    .crumbs__link:hover{ text-decoration: underline; }
    .crumbs__sep{ opacity: 0.85; }
    .crumbs__current{
      font-weight: 750;
      letter-spacing: 0.02em;
      font-size: 13px;
    }

    .head{
      padding: 18px;
      border-radius: 18px;
      border: 1px solid rgba(176,141,60,0.18);
      background: rgba(11,11,16,0.55);
      box-shadow: var(--shadow);
    }

    .head__top{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .head__title{
      margin: 0;
      font-size: 22px;
      font-weight: 850;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .head__updated{
      font-weight: 650;
      letter-spacing: 0.02em;
      opacity: 0.92;
    }

    .head__summary{
      margin: 12px 0 0;
      font-size: 15px;
      font-weight: 650;
      letter-spacing: 0.02em;
      line-height: 1.6;
    }

    .tags{
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(176,141,60,0.22);
      background: rgba(11,11,16,0.45);
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 11px;
    }

    .media{
      margin-top: 14px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(176,141,60,0.18);
      background: rgba(11,11,16,0.6);
    }

    /* ✅ This prevents the “giant stretched banner” feeling */
    .media{
  margin-top: 14px;
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid rgba(176,141,60,0.18);
  background: rgba(11,11,16,0.6);
}

/* Default (landscape): banner look, crops nicely */
.media__img{
  display: block;
  width: 100%;
  max-height: 260px;
  object-fit: cover;
}

/* Portrait: show the whole image (no cropping), centered */
.media.media--portrait{
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 16px;          /* gives breathing room */
}

.media.media--portrait .media__img{
  width: auto;            /* don't force full width */
  max-width: 100%;
  max-height: 680px;      /* allow taller portraits */
  object-fit: contain;    /* show the whole image */
  border-radius: 14px;    /* optional: softer inside */
}

    .body{
      padding: 18px;
      border-radius: 18px;
      border: 1px solid rgba(176,141,60,0.18);
      background: rgba(11,11,16,0.55);
      box-shadow: var(--shadow);
    }

    .body :global(h2),
    .body :global(h3){
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .body :global(p),
    .body :global(li){
      font-size: 15px;
      font-weight: 650;
      letter-spacing: 0.02em;
      line-height: 1.75;
      color: var(--text);
    }

    .body :global(ul){
      padding-left: 18px;
    }

    .body :global(hr){
      border: none;
      border-top: 1px solid rgba(176,141,60,0.18);
      margin: 18px 0;
    }
    .related{
  padding: 18px;
  border-radius: 18px;
  border: 1px solid rgba(176,141,60,0.18);
  background: rgba(11,11,16,0.55);
  box-shadow: var(--shadow);
}

.related__title{
  margin: 0 0 12px 0;
  font-size: 12px;
  font-weight: 850;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  opacity: 0.9;
}

.related__grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

@media (min-width: 720px){
  .related__grid{
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

.related__item{
  display: block;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid rgba(176,141,60,0.18);
  background: rgba(15,15,22,0.35);
  text-decoration: none;
  color: var(--text);
  transition: transform 120ms ease, border-color 120ms ease;
}

.related__item:hover{
  transform: translateY(-1px);
  border-color: rgba(176,141,60,0.35);
}

.related__name{
  font-weight: 850;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  font-size: 12px;
  margin-bottom: 6px;
}

.related__summary{
  font-size: 14px;
  font-weight: 650;
  letter-spacing: 0.02em;
  line-height: 1.5;
  opacity: 0.9;
  margin-bottom: 8px;
}

.related__meta{
  font-size: 12px;
  font-weight: 650;
  letter-spacing: 0.02em;
  opacity: 0.75;
}
.toc{
  position: relative;
  padding: 16px 16px 14px;
  border-radius: 18px;
  border: 1px solid rgba(176,141,60,0.22);
  background: linear-gradient(
    180deg,
    rgba(176,141,60,0.10),
    rgba(11,11,16,0.55) 40%,
    rgba(11,11,16,0.55)
  );
  box-shadow: var(--shadow);
  overflow: hidden;
}

/* subtle gold accent bar */
.toc::before{
  content: "";
  position: absolute;
  left: 0;
  top: 12px;
  bottom: 12px;
  width: 3px;
  border-radius: 999px;
  background: rgba(176,141,60,0.55);
}

.toc__top{
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 12px;
  padding-left: 10px; /* room for accent bar */
}

.toc__title{
  font-weight: 900;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  font-size: 12px;
  opacity: 0.95;
}

.toc__nav{
  margin-top: 10px;
  padding-left: 10px; /* align with title */
}

.toc__list{
  margin: 0;
  padding: 0;
  list-style: none;
  display: grid;
  gap: 6px;
}

.toc__item{
  position: relative;
}

.toc__link{
  display: inline-block;
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
  opacity: 0.92;
  font-weight: 700;
  font-size: 14px;
  line-height: 1.35;
  padding: 4px 6px;
  border-radius: 10px;
  transition: background 120ms ease, opacity 120ms ease, transform 120ms ease;
}

.toc__link:hover{
  background: rgba(176,141,60,0.12);
  opacity: 1;
  transform: translateY(-1px);
}

/* depth styling */
.toc__item--d3 .toc__link{
  font-weight: 650;
  font-size: 13px;
  opacity: 0.85;
  margin-left: 12px;
}


  </style>

  <script>
  // Detect portrait images and switch styling so they don't get cropped
  const mediaImages = document.querySelectorAll(".media__img");

  mediaImages.forEach((node) => {
    if (!(node instanceof HTMLImageElement)) return;

    const setMediaFit = () => {
      const w = node.naturalWidth;
      const h = node.naturalHeight;
      if (!w || !h) return;

      const wrap = node.closest(".media");
      if (!wrap) return;

      const isPortrait = h > w;
      wrap.classList.toggle("media--portrait", isPortrait);
    };

    if (node.complete) setMediaFit();
    else node.addEventListener("load", setMediaFit, { once: true });
  });
</script>

<script>
  // Add ids to headings inside the entry body so TOC links can jump correctly
  const body = document.querySelector("[data-entry-body]");
  if (body) {
    const hs = body.querySelectorAll("h2, h3");
    hs.forEach((h) => {
      if (!h.id) {
        const text = (h.textContent || "").trim().toLowerCase();
        const slug = text
          .replace(/[^a-z0-9\s-]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-");
        if (slug) h.id = slug;
      }
    });
  }
</script>


</MainLayout>
